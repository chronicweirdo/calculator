<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta content="width=device-width, initial-scale=1" name="viewport"/>
        <meta name="viewport"
          content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, height=device-height">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="theme-color" content="#df005e">
        <script>
            function getViewportWidth() {
                return Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
            }

            function getViewportHeight() {
                return Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
            }

            function calculate(){
                let eq = document.getElementById("equation")
                try {
                    let expression = eq.value
                    let result = Function('"use strict";return (' + expression + ')')()
                    document.getElementById("result").innerHTML = result
                } catch (error) {
                    document.getElementById("result").innerHTML = "?"
                }
                eq.focus()
            }
            function insert(ch) {
                let eq = document.getElementById("equation")
                let currentVal = eq.value
                let start = eq.selectionStart
                let end = eq.selectionEnd
                eq.value = currentVal.slice(0, start) + ch + currentVal.slice(end)
                eq.focus()
                eq.selectionStart = start+ch.length
                eq.selectionEnd = start+ch.length
            }
            function backspace() {
                let eq = document.getElementById("equation")
                let currentVal = eq.value
                let start = eq.selectionStart
                let end = eq.selectionEnd
                if (start == end && start > 0) {
                    eq.value = currentVal.slice(0, start-1) + currentVal.slice(end)
                    eq.selectionStart = start-1
                    eq.selectionEnd = start-1
                } else {
                    eq.value = currentVal.slice(0, start) + currentVal.slice(end)
                    eq.selectionStart = start
                    eq.selectionEnd = start
                }
                eq.focus()
            }
            function left() {
                let eq = document.getElementById("equation")
                let start = eq.selectionStart
                if (start > 0) {
                    eq.selectionStart = start-1
                    eq.selectionEnd = start-1
                }
                eq.focus()
            }
            function right() {
                let eq = document.getElementById("equation")
                let end = eq.selectionEnd
                if (end < eq.value.length) {
                    eq.selectionStart = end+1
                    eq.selectionEnd = end+1
                }
                eq.focus()
            }
            function dateToString(d) {
                return d.getFullYear() + "/" + d.getMonth() + "/" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes()
            }
            function memDelete(k) {
                window.localStorage.removeItem(k)
                mem()
            }
            function memSave() {
                let equation = document.getElementById("equation").value
                let result = document.getElementById("result").innerHTML
                let date = new Date()
                let name = dateToString(date)
                if (result != "?") {
                    // save this value
                    let val = {
                        eq: equation,
                        res: result,
                        name: name,
                        ts: date.getTime()
                    }
                    window.localStorage.setItem(equation, JSON.stringify(val))
                }
            }
            function but(text, func) {
                let b = document.createElement("button")
                b.innerHTML = text
                b.onclick = func
                return b
            }
            function getMemoryNameInput(v) {
                let input = document.createElement("input")
                input.value = v.name
                input.onchange = () => {
                    if (input.value.length > 0) {
                        v.name = input.value
                        window.localStorage.setItem(v.eq, JSON.stringify(v))
                    }
                }
                return input
            }
            function wrapWithTd(element) {
                let td = document.createElement("td")
                td.appendChild(element)
                return td
            }
            function addRows(table, v) {
                let nameRow = document.createElement("tr")
                nameRow.appendChild(wrapWithTd(getMemoryNameInput(v)))
                nameRow.appendChild(wrapWithTd(but("x", () => memDelete(v.eq))))
                table.appendChild(nameRow)
                
                let dataRow = document.createElement("tr")
                dataRow.appendChild(wrapWithTd(but(v.eq, () => {
                    hideMem()
                    insert(v.eq)
                })))
                dataRow.appendChild(wrapWithTd(but(v.res, () => {
                    hideMem()
                    insert(v.res)
                })))
                table.appendChild(dataRow)
            }
            function getEndRow() {
                let tr = document.createElement("tr")
                let n = document.createElement("td")
                n.appendChild(but("x", () => hideMem()))
                tr.appendChild(n)
                return tr
            }
            function getMemoryArray() {
                let keys = Object.keys(window.localStorage)
                let items = []
                for (k in keys) {
                    let v = JSON.parse(window.localStorage.getItem(keys[k]))
                    items.push(v)
                }
                items.sort((a, b) => a.ts - b.ts)
                return items
            }
            function mem() {
                let m = document.getElementById("mem")
                m.innerHTML = ""
                getMemoryArray().forEach(v => addRows(m, v))
                m.appendChild(getEndRow())
                m.style.display = "block"
                let c = document.getElementById("controls")
                c.style.display = "none"
            }
            function hideMem() {
                let m = document.getElementById("mem")
                m.style.display = "none"
                let c = document.getElementById("controls")
                c.style.display = "grid"
                document.getElementById("equation").focus()
            }
            function cls() {
                let eq = document.getElementById("equation")
                eq.value = ""
                eq.focus()
            }
            function resize() {
                let pad = 20
                document.body.style.padding = pad + "px"
                let c = document.getElementById("controls")
                c.style.height = (getViewportHeight() - pad * 2) + "px"
                c.style.width = (getViewportWidth() - pad * 2) + "px"
                let m = document.getElementById("mem")
                m.style.width = (getViewportWidth() - pad * 2) + "px"
            }
            window.onload = function() {
                resize()
                calculate()
            }
            window.onresize = resize
        </script>
        <style>
            * {
                font-size: 5vmin;
                padding: 0;
                margin: 0;
                touch-action: manipulation;
            }

            #controls {
                display: grid;
                grid-template-columns: repeat(4, 25%);
                grid-template-rows: 65% repeat(7, 5%);
                grid-template-areas: 
                    'eqa eqa eqa eqa'
                    'equ res res res'
                    'cls lef rig bsp'
                    'mps mem pop pcl'
                    'b7 b8 b9 div'
                    'b4 b5 b6 mul'
                    'b1 b2 b3 min'
                    'b0 b0 pt pls'
                    ;
            }
            #controls > * {
                border: 1px solid white;
            }
            #equation, #equation:focus, #equation:focus-visible {
                resize: none;
                border: 0;
                inset: 0;
                outline: none;
            }
            #result {
                text-align: center;
            }
            #mem {
                display: none;
                word-break: break-all;
            }
            td {
                border: 1px solid black;
            }
        </style>
    </head>
    <body>
        <div id="controls">
            <textarea style="grid-area: eqa" id="equation" name="equation" inputmode="none" onchange="calculate()" onkeyup="calculate()" onfocus="calculate()"></textarea>

            <button style="grid-area: equ" id="equals" onclick="calculate()">=</button>
            <span style="grid-area: res" id="result"></span>

            <button style="grid-area: b0" type="button" onclick="insert('0')">0</button>
            <button style="grid-area: b1" type="button" onclick="insert('1')">1</button>
            <button style="grid-area: b2" type="button" onclick="insert('2')">2</button>
            <button style="grid-area: b3" type="button" onclick="insert('3')">3</button>
            <button style="grid-area: b4" type="button" onclick="insert('4')">4</button>
            <button style="grid-area: b5" type="button" onclick="insert('5')">5</button>
            <button style="grid-area: b6" type="button" onclick="insert('6')">6</button>
            <button style="grid-area: b7" type="button" onclick="insert('7')">7</button>
            <button style="grid-area: b8" type="button" onclick="insert('8')">8</button>
            <button style="grid-area: b9" type="button" onclick="insert('9')">9</button>
            <button style="grid-area: pt" type="button" onclick="insert('.')">.</button>
            <button style="grid-area: pls" type="button" onclick="insert('+')">+</button>
            <button style="grid-area: min" type="button" onclick="insert('-')">-</button>
            <button style="grid-area: mul" type="button" onclick="insert('*')">*</button>
            <button style="grid-area: div" type="button" onclick="insert('/')">/</button>
            <button style="grid-area: pop" type="button" onclick="insert('(')">(</button>
            <button style="grid-area: pcl" type="button" onclick="insert(')')">)</button>
            <button style="grid-area: bsp" type="button" onclick="backspace()">⤆</button>
            <button style="grid-area: cls" type="button" onclick="cls()">C</button>

            <button style="grid-area: lef" type="button" onclick="left()">←</button>
            <button style="grid-area: rig" type="button" onclick="right()">→</button>
            <button style="grid-area: mps" type="button" onclick="memSave()">M+</button>
            <button style="grid-area: mem" type="button" onclick="mem()">M</button>
        </div>
        <table id="mem">
        </table>
    </body>
</html>